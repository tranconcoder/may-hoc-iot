{{!-- Trang quản lý camera --}}

<link rel="stylesheet" href="/public/css/camera-managment.css">

<div class="container-fluid camera-management-page">
  <div class="page-header">
    <h1 class="page-title">Quản lý Camera</h1>
    <div class="page-actions">
      <button class="btn btn-primary" id="btnAddCamera">
        <i class="fas fa-plus"></i> Thêm Camera
      </button>
      <button class="btn btn-secondary" id="btnRefreshCameras">
        <i class="fas fa-sync-alt"></i> Làm mới
      </button>
    </div>
  </div>

  <div class="camera-filter-bar">
    <div class="filter-group">
      <label for="cameraStatusFilter">Trạng thái:</label>
      <select id="cameraStatusFilter" class="form-control">
        <option value="all">Tất cả</option>
        <option value="active">Đang hoạt động</option>
        <option value="inactive">Không hoạt động</option>
        <option value="maintenance">Bảo trì</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="cameraLocationFilter">Khu vực:</label>
      <select id="cameraLocationFilter" class="form-control">
        <option value="all">Tất cả khu vực</option>
        <option value="north">Khu vực Bắc</option>
        <option value="central">Khu vực Trung</option>
        <option value="south">Khu vực Nam</option>
      </select>
    </div>
    <div class="filter-group search-group">
      <input type="text" id="cameraSearchInput" class="form-control" placeholder="Tìm kiếm camera...">
      <button class="btn btn-outline-secondary" id="btnSearch">
        <i class="fas fa-search"></i>
      </button>
    </div>
  </div>

  <div class="camera-grid-container">
    <div class="camera-grid">
      {{#if cameras.length}}
        {{#each cameras}}
          <div class="camera-card" data-camera-id="{{this.id}}">
            <div class="camera-preview">
              <img src="{{this.previewUrl}}" alt="{{this.name}}" onerror="this.src='/img/camera-offline.jpg'">
              <div class="camera-status {{this.status}}">
                <i class="fas fa-circle"></i>
                <span>{{this.statusText}}</span>
              </div>
            </div>
            <div class="camera-info">
              <h3 class="camera-name">{{this.name}}</h3>
              <p class="camera-location"><i class="fas fa-map-marker-alt"></i> {{this.location}}</p>
              <p class="camera-ip"><i class="fas fa-network-wired"></i> {{this.ipAddress}}</p>
            </div>
            <div class="camera-actions">
              <button class="btn btn-sm btn-primary btn-view" data-id="{{this.id}}">
                <i class="fas fa-eye"></i> Xem
              </button>
              <button class="btn btn-sm btn-info btn-edit" data-id="{{this.id}}">
                <i class="fas fa-edit"></i> Sửa
              </button>
              <button class="btn btn-sm btn-danger btn-delete" data-id="{{this.id}}">
                <i class="fas fa-trash"></i> Xóa
              </button>
            </div>
          </div>
        {{/each}}
      {{else}}
        <div class="no-cameras-found">
          <i class="fas fa-video-slash"></i>
          <p>Không có camera nào được tìm thấy</p>
          <button class="btn btn-primary" id="btnAddFirstCamera">Thêm camera đầu tiên</button>
        </div>
      {{/if}}
    </div>
  </div>
</div>

<!-- Modal thêm/sửa camera -->
<div class="modal fade" id="cameraModal" tabindex="-1" role="dialog" aria-labelledby="cameraModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cameraModalLabel">Thêm Camera Mới</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="cameraForm">
          <div class="form-group">
            <label for="cameraName">Tên camera</label>
            <input type="text" class="form-control" id="cameraName" required>
          </div>
          <div class="form-group">
            <label for="cameraLocation">Vị trí</label>
            <input type="text" class="form-control" id="cameraLocation" required>
          </div>
          <div class="form-group">
            <label for="cameraIpAddress">Địa chỉ IP</label>
            <input type="text" class="form-control" id="cameraIpAddress" required>
          </div>
          <div class="form-group">
            <label for="cameraStreamUrl">URL Stream</label>
            <input type="text" class="form-control" id="cameraStreamUrl" required>
          </div>
          <div class="form-group">
            <label for="cameraUsername">Tên đăng nhập (nếu có)</label>
            <input type="text" class="form-control" id="cameraUsername">
          </div>
          <div class="form-group">
            <label for="cameraPassword">Mật khẩu (nếu có)</label>
            <input type="password" class="form-control" id="cameraPassword">
          </div>
          <div class="form-group">
            <label for="cameraStatus">Trạng thái</label>
            <select class="form-control" id="cameraStatus">
              <option value="active">Hoạt động</option>
              <option value="inactive">Không hoạt động</option>
              <option value="maintenance">Bảo trì</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-primary" id="btnSaveCamera">Lưu</button>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript cho tương tác trang quản lý camera -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Khởi tạo các event listeners
    const btnAddCamera = document.getElementById('btnAddCamera');
    const btnAddFirstCamera = document.getElementById('btnAddFirstCamera');
    const btnSaveCamera = document.getElementById('btnSaveCamera');
    const cameraModal = document.getElementById('cameraModal');
    
    // Nút thêm camera
    if (btnAddCamera) {
      btnAddCamera.addEventListener('click', function() {
        // Reset form và hiển thị modal
        document.getElementById('cameraForm').reset();
        document.getElementById('cameraModalLabel').textContent = 'Thêm Camera Mới';
        // Hiển thị modal (giả định bạn đang sử dụng Bootstrap)
        $('#cameraModal').modal('show');
      });
    }
    
    // Nút thêm camera đầu tiên
    if (btnAddFirstCamera) {
      btnAddFirstCamera.addEventListener('click', function() {
        document.getElementById('cameraForm').reset();
        document.getElementById('cameraModalLabel').textContent = 'Thêm Camera Đầu Tiên';
        $('#cameraModal').modal('show');
      });
    }
    
    // Nút lưu camera
    if (btnSaveCamera) {
      btnSaveCamera.addEventListener('click', function() {
        // Validate form
        const form = document.getElementById('cameraForm');
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }
        
        // Thu thập dữ liệu từ form
        const cameraData = {
          name: document.getElementById('cameraName').value,
          location: document.getElementById('cameraLocation').value,
          ipAddress: document.getElementById('cameraIpAddress').value,
          streamUrl: document.getElementById('cameraStreamUrl').value,
          username: document.getElementById('cameraUsername').value,
          password: document.getElementById('cameraPassword').value,
          status: document.getElementById('cameraStatus').value
        };
        
        // Gửi dữ liệu đến server (API)
        fetch('/api/cameras', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(cameraData)
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Không thể lưu camera');
          }
          return response.json();
        })
        .then(data => {
          // Đóng modal
          $('#cameraModal').modal('hide');
          
          // Làm mới trang để hiển thị camera mới
          location.reload();
        })
        .catch(error => {
          alert('Lỗi: ' + error.message);
        });
      });
    }
    
    // Xử lý nút sửa camera
    const editButtons = document.querySelectorAll('.btn-edit');
    editButtons.forEach(button => {
      button.addEventListener('click', function() {
        const cameraId = this.getAttribute('data-id');
        
        // Lấy thông tin camera từ server
        fetch(`/api/cameras/${cameraId}`)
          .then(response => response.json())
          .then(camera => {
            // Điền thông tin vào form
            document.getElementById('cameraName').value = camera.name;
            document.getElementById('cameraLocation').value = camera.location;
            document.getElementById('cameraIpAddress').value = camera.ipAddress;
            document.getElementById('cameraStreamUrl').value = camera.streamUrl;
            document.getElementById('cameraUsername').value = camera.username || '';
            document.getElementById('cameraPassword').value = ''; // Không hiển thị mật khẩu
            document.getElementById('cameraStatus').value = camera.status;
            
            // Cập nhật tiêu đề modal
            document.getElementById('cameraModalLabel').textContent = 'Sửa Camera';
            
            // Lưu ID camera để sử dụng khi cập nhật
            btnSaveCamera.setAttribute('data-camera-id', cameraId);
            
            // Hiển thị modal
            $('#cameraModal').modal('show');
          })
          .catch(error => {
            alert('Không thể lấy thông tin camera: ' + error.message);
          });
      });
    });
    
    // Xử lý nút xóa camera
    const deleteButtons = document.querySelectorAll('.btn-delete');
    deleteButtons.forEach(button => {
      button.addEventListener('click', function() {
        if (confirm('Bạn có chắc chắn muốn xóa camera này?')) {
          const cameraId = this.getAttribute('data-id');
          
          fetch(`/api/cameras/${cameraId}`, {
            method: 'DELETE'
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('Không thể xóa camera');
            }
            return response.json();
          })
          .then(() => {
            // Xóa camera khỏi giao diện hoặc làm mới trang
            const cameraCard = document.querySelector(`.camera-card[data-camera-id="${cameraId}"]`);
            if (cameraCard) {
              cameraCard.remove();
            }
            
            // Nếu không còn camera nào, hiển thị thông báo
            const remainingCameras = document.querySelectorAll('.camera-card');
            if (remainingCameras.length === 0) {
              location.reload(); // Làm mới để hiển thị thông báo "không có camera"
            }
          })
          .catch(error => {
            alert('Lỗi: ' + error.message);
          });
        }
      });
    });
    
    // Xử lý nút xem camera
    const viewButtons = document.querySelectorAll('.btn-view');
    viewButtons.forEach(button => {
      button.addEventListener('click', function() {
        const cameraId = this.getAttribute('data-id');
        // Chuyển hướng đến trang xem camera chi tiết
        window.location.href = `/views/dashboard/cameras/${cameraId}`;
      });
    });
    
    // Xử lý tìm kiếm và lọc
    const searchInput = document.getElementById('cameraSearchInput');
    const statusFilter = document.getElementById('cameraStatusFilter');
    const locationFilter = document.getElementById('cameraLocationFilter');
    
    function applyFilters() {
      const searchTerm = searchInput.value.toLowerCase();
      const statusValue = statusFilter.value;
      const locationValue = locationFilter.value;
      
      const cameras = document.querySelectorAll('.camera-card');
      
      cameras.forEach(camera => {
        const cameraName = camera.querySelector('.camera-name').textContent.toLowerCase();
        const cameraLocation = camera.querySelector('.camera-location').textContent.toLowerCase();
        const cameraStatus = camera.querySelector('.camera-status').classList.contains(statusValue);
        
        // Áp dụng bộ lọc
        let showCamera = true;
        
        // Lọc theo tên/vị trí
        if (searchTerm && !cameraName.includes(searchTerm) && !cameraLocation.includes(searchTerm)) {
          showCamera = false;
        }
        
        // Lọc theo trạng thái
        if (statusValue !== 'all' && !cameraStatus) {
          showCamera = false;
        }
        
        // Lọc theo khu vực
        if (locationValue !== 'all') {
          const locationMatch = camera.querySelector('.camera-location').textContent.toLowerCase().includes(locationValue.toLowerCase());
          if (!locationMatch) {
            showCamera = false;
          }
        }
        
        // Hiển thị hoặc ẩn camera
        camera.style.display = showCamera ? '' : 'none';
      });
    }
    
    if (searchInput) searchInput.addEventListener('input', applyFilters);
    if (statusFilter) statusFilter.addEventListener('change', applyFilters);
    if (locationFilter) locationFilter.addEventListener('change', applyFilters);
  });
</script>
