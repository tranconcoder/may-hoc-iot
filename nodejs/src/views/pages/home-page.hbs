{{! filepath: /home/tranv/Workspace/mh-iot-new/nodejs/src/views/pages/home-page.hbs }}
<div class="content-header">
  <h1 class="page-title">Tổng quan về lưu lượng giao thông</h1>
  <div class="date-time">
    <i class="far fa-calendar-alt"></i>
    <span id="current-date"></span>
  </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body d-flex align-items-center">
        <div class="flex-shrink-0 rounded-circle bg-primary bg-opacity-10 p-3 me-3">
          <i class="fas fa-car text-primary fa-2x"></i>
        </div>
        <div>
          <h6 class="text-muted mb-1">Tổng phương tiện</h6>
          <h3 class="mb-0 counter" id="totalVehicles">
            {{#if data}}
              {{totalVehiclesCount}}
            {{else}}
              --
            {{/if}}
          </h3>
          <small class="text-success"><i class="fas fa-arrow-up"></i> 
            {{#if data}}
              {{percentChange}}% so với tuần trước
            {{else}}
              -- so với tuần trước
            {{/if}}
          </small>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body d-flex align-items-center">
        <div class="flex-shrink-0 rounded-circle bg-success bg-opacity-10 p-3 me-3">
          <i class="fas fa-video text-success fa-2x"></i>
        </div>
        <div>
          <h6 class="text-muted mb-1">Camera hoạt động</h6>
          <h3 class="mb-0 counter">15/18</h3>
          <small class="text-muted">3 camera đang bảo trì</small>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body d-flex align-items-center">
        <div class="flex-shrink-0 rounded-circle bg-warning bg-opacity-10 p-3 me-3">
          <i class="fas fa-exclamation-triangle text-warning fa-2x"></i>
        </div>
        <div>
          <h6 class="text-muted mb-1">Cảnh báo tắc nghẽn</h6>
          <h3 class="mb-0 counter">3</h3>
          <small class="text-danger"><i class="fas fa-arrow-up"></i> 2 so với hôm qua</small>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body d-flex align-items-center">
        <div class="flex-shrink-0 rounded-circle bg-info bg-opacity-10 p-3 me-3">
          <i class="fas fa-traffic-light text-info fa-2x"></i>
        </div>
        <div>
          <h6 class="text-muted mb-1">Đèn giao thông</h6>
          <h3 class="mb-0 counter">42/45</h3>
          <small class="text-success">93% hoạt động bình thường</small>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Main Content Sections -->
<div class="row">
  <!-- Traffic Flow Chart -->
  <div class="col-lg-8 mb-4">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Lưu lượng giao thông theo thời gian</h5>
        <div class="dropdown">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
            {{#if data}}
              {{data.startDate}} - {{data.endDate}}
            {{else}}
              Chọn thời gian
            {{/if}}
          </button>
          <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <li><a class="dropdown-item" href="#" data-range="day">Hôm nay</a></li>
            <li><a class="dropdown-item" href="#" data-range="week">Tuần này</a></li>
            <li><a class="dropdown-item" href="#" data-range="month">Tháng này</a></li>
          </ul>
        </div>
      </div>
      <div class="card-body">
        {{#if error}}
          <div class="alert alert-warning">{{error}}</div>
        {{/if}}
        <div class="chart-container" style="position: relative; height: 250px;">
          <canvas id="trafficFlowChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Traffic Distribution -->
  <div class="col-lg-4 mb-4">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-white">
        <h5 class="mb-0">Phân bố phương tiện</h5>
      </div>
      <div class="card-body">
        {{#if error}}
          <div class="alert alert-warning">{{error}}</div>
        {{/if}}
        <div class="chart-container" style="position: relative; height: 250px;">
          <canvas id="vehicleDistributionChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Recent Alerts -->
  <div class="col-lg-12 mb-4">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-white">
        <h5 class="mb-0">Cảnh báo gần đây</h5>
      </div>
      <div class="card-body p-0">
        <div class="list-group list-group-flush">
          <a href="#" class="list-group-item list-group-item-action py-3">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1 text-danger">Tắc nghẽn giao thông</h6>
              <small class="text-muted">10 phút trước</small>
            </div>
            <p class="mb-1 small">Phát hiện tắc nghẽn tại đường Lê Duẩn, đoạn gần ngã tư Lê Duẩn - Nam Kỳ Khởi Nghĩa</p>
            <small class="text-muted">Camera 03</small>
          </a>
          <a href="#" class="list-group-item list-group-item-action py-3">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1 text-warning">Mật độ giao thông cao</h6>
              <small class="text-muted">25 phút trước</small>
            </div>
            <p class="mb-1 small">Mật độ giao thông tăng cao tại ngã tư Nguyễn Huệ - Lê Lợi</p>
            <small class="text-muted">Camera 01</small>
          </a>
          <a href="#" class="list-group-item list-group-item-action py-3">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1 text-danger">Đèn giao thông không hoạt động</h6>
              <small class="text-muted">1 giờ trước</small>
            </div>
            <p class="mb-1 small">Đèn giao thông tại ngã tư Điện Biên Phủ - 3/2 không hoạt động</p>
            <small class="text-muted">Camera 08</small>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Map section removed as requested -->

{{#if data}}
<script>
  // Prepare data for charts from server data
  const trafficData = {
    labels: [
      {{#each data.statistics}}
        "{{this.date}}",
      {{/each}}
    ],
    datasets: [{
      label: 'Tổng phương tiện',
      data: [
        {{#each data.statistics}}
          {{this.totalVehicles}},
        {{/each}}
      ],
      borderColor: 'rgba(75, 192, 192, 1)',
      tension: 0.1,
      fill: false
    }]
  };
  
  const vehicleTypes = {
    car: 0,
    truck: 0,
    bus: 0,
    motorcycle: 0
  };
  
  // Calculate total by vehicle type
  {{#each data.statistics}}
    vehicleTypes.car += {{this.vehicles.car}};
    vehicleTypes.truck += {{this.vehicles.truck}};
    vehicleTypes.bus += {{this.vehicles.bus}};
    vehicleTypes.motorcycle += {{this.vehicles.motorcycle}};
  {{/each}}
  
  const distributionData = {
    labels: ['Ô tô', 'Xe tải', 'Xe buýt', 'Xe máy'],
    datasets: [{
      data: [
        vehicleTypes.car,
        vehicleTypes.truck,
        vehicleTypes.bus,
        vehicleTypes.motorcycle
      ],
      backgroundColor: [
        'rgba(54, 162, 235, 0.7)',
        'rgba(255, 206, 86, 0.7)',
        'rgba(75, 192, 192, 0.7)',
        'rgba(255, 99, 132, 0.7)'
      ]
    }]
  };
  
  // Initialize charts when DOM is loaded
  document.addEventListener('DOMContentLoaded', function() {
    // Traffic Flow Chart
    const flowCtx = document.getElementById('trafficFlowChart').getContext('2d');
    new Chart(flowCtx, {
      type: 'line',
      data: trafficData,
      options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
    
    // Vehicle Distribution Chart
    const distCtx = document.getElementById('vehicleDistributionChart').getContext('2d');
    new Chart(distCtx, {
      type: 'doughnut',
      data: distributionData,
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  });
</script>
{{/if}}

<script>
  // Set current date
  document.getElementById('current-date').textContent = new Date().toLocaleDateString('vi-VN', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
</script>

<style>
  .camera-feed {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }
  
  .camera-overlay {
    position: absolute;
    top: 10px;
    left: 10px;
  }
  
  .camera-info {
    background-color: rgba(255,255,255,0.9);
    border-radius: 0 0 8px 8px;
  }
  
  .counter {
    font-weight: 600;
  }
  
  .chart-container {
    width: 100%;
    height: 250px;
  }
</style>
